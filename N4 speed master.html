<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N4 Speed Master AI - Tr·ª£ L√Ω Luy·ªán Thi Th√¥ng Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', 'Noto Sans JP', sans-serif; background-color: #FDFBF7; color: #1F2937; }
        .font-jp { font-family: 'Noto Sans JP', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: auto; height: 300px; max-height: 400px; }
        .loading-dots:after { content: '.'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl font-bold text-red-700">N4</span>
                    <span class="font-medium text-gray-600">Speed Master ‚ú® AI</span>
                </div>
                <div class="hidden md:flex space-x-6 items-center">
                    <button onclick="navTo('dashboard')" class="hover:text-red-600 font-medium text-sm transition">T·ªïng Quan</button>
                    <button onclick="navTo('grammar-ai')" class="hover:text-blue-600 font-medium text-sm transition">AI Sensei ‚ú®</button>
                    <button onclick="navTo('kanji-ai')" class="hover:text-red-600 font-medium text-sm transition">AI Kanji ‚ú®</button>
                    <button onclick="navTo('vocab')" class="hover:text-green-600 font-medium text-sm transition">T·ª´ V·ª±ng</button>
                </div>
                <div class="flex items-center md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-2xl p-2 focus:outline-none">‚ò∞</button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu Container -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-50 border-t p-4 space-y-2 shadow-inner">
            <button onclick="navTo('dashboard')" class="block w-full text-left py-2 px-4 hover:bg-gray-100 rounded">T·ªïng Quan</button>
            <button onclick="navTo('grammar-ai')" class="block w-full text-left py-2 px-4 hover:bg-gray-100 rounded">AI Sensei ‚ú®</button>
            <button onclick="navTo('kanji-ai')" class="block w-full text-left py-2 px-4 hover:bg-gray-100 rounded">AI Kanji ‚ú®</button>
            <button onclick="navTo('vocab')" class="block w-full text-left py-2 px-4 hover:bg-gray-100 rounded">T·ª´ V·ª±ng</button>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- SECTION: DASHBOARD -->
        <section id="dashboard" class="space-y-8">
            <div class="bg-gradient-to-r from-red-50 to-blue-50 p-8 rounded-2xl border border-gray-100">
                <h1 class="text-3xl font-bold text-gray-800">H·ªçc N4 Th√¥ng Minh V·ªõi AI</h1>
                <p class="mt-2 text-gray-600">H·ªá th·ªëng ƒë√£ ph√¢n t√≠ch t√†i li·ªáu N4 c·ªßa b·∫°n v√† s·∫µn s√†ng h·ªó tr·ª£ gi·∫£i th√≠ch ng·ªØ ph√°p, t·ª´ v·ª±ng b·∫±ng tr√≠ tu·ªá nh√¢n t·∫°o.</p>
                <div class="mt-6 flex space-x-4">
                    <button onclick="navTo('grammar-ai')" class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium hover:bg-blue-700 transition">Th·ª≠ AI Sensei ‚ú®</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Ph√¢n B·ªï Ki·∫øn Th·ª©c</h3>
                    <div class="chart-container"><canvas id="contentChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Ti·∫øn ƒê·ªô M·ª•c Ti√™u</h3>
                    <div class="chart-container"><canvas id="progressChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- SECTION: GRAMMAR AI -->
        <section id="grammar-ai" class="hidden space-y-6">
            <div class="bg-blue-900 text-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="mr-2">‚ú®</span> AI Sensei - Gi·∫£i Th√≠ch Ng·ªØ Ph√°p
                </h2>
                <p class="opacity-80 mt-2">D√°n m·ªôt c√¢u ti·∫øng Nh·∫≠t ho·∫∑c m·∫´u ng·ªØ ph√°p N4, AI s·∫Ω ph√¢n t√≠ch chi ti·∫øt cho b·∫°n.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Nh·∫≠p c√¢u c·∫ßn ph√¢n t√≠ch:</label>
                        <textarea id="grammarInput" rows="4" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 font-jp" placeholder="V√≠ d·ª•: „ÅÇ„Åó„Åü„ÅØÈõ®„ÅåÈôç„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ"></textarea>
                        <button onclick="analyzeGrammar()" id="btnAnalyze" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ph√¢n T√≠ch V·ªõi AI ‚ú®</button>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2 text-sm">G·ª£i √Ω t·ª´ t√†i li·ªáu N4:</h4>
                        <ul class="text-xs space-y-2">
                            <li class="cursor-pointer text-blue-600 hover:underline" onclick="setInput('„ÅÇ„Åó„Åü„ÅØÈõ®„ÅåÈôç„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ')">„Éª ~„Åß„Åó„Çá„ÅÜ (Ph√°n ƒëo√°n)</li>
                            <li class="cursor-pointer text-blue-600 hover:underline" onclick="setInput('ÈÉ®Èï∑„Åå„Åä„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åó„Åü„ÄÇ')">„Éª K√≠nh ng·ªØ (T√¥n k√≠nh)</li>
                            <li class="cursor-pointer text-blue-600 hover:underline" onclick="setInput('Èñì„Å´Âêà„Çè„Å™„ÅÑ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ')">„Éª ~„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ (Kh·∫£ nƒÉng)</li>
                        </ul>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div id="grammarResult" class="bg-white p-6 rounded-lg shadow min-h-[300px] border-2 border-dashed border-gray-200 flex flex-col justify-center items-center text-gray-400">
                        <div id="aiPlaceholder">K·∫øt qu·∫£ ph√¢n t√≠ch s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y...</div>
                        <div id="aiLoading" class="hidden text-blue-600 font-bold">
                            <span class="loading-dots">AI ƒëang suy nghƒ©</span>
                        </div>
                        <div id="aiContent" class="hidden w-full text-gray-800"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: KANJI AI -->
        <section id="kanji-ai" class="hidden space-y-6">
            <div class="bg-red-700 text-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold flex items-center">
                    <span class="mr-2">‚ú®</span> AI Kanji Master - Gi·∫£i M√£ H√°n T·ª±
                </h2>
                <p class="opacity-80 mt-2">H·ªçc Kanji qua c√¢u chuy·ªán v√† h√¨nh ·∫£nh do AI s√°ng t·∫°o.</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div onclick="explainKanji('ÂÉç')" class="bg-white p-6 rounded-xl border-2 border-transparent hover:border-red-500 cursor-pointer shadow-sm transition text-center group">
                    <div class="text-5xl font-jp mb-2 group-hover:scale-110 transition">ÂÉç</div>
                    <div class="text-sm font-bold text-gray-500">ƒê·ªòNG (L√†m vi·ªác)</div>
                    <div class="mt-3 text-xs bg-red-50 text-red-700 py-1 rounded">Gi·∫£i th√≠ch AI ‚ú®</div>
                </div>
                <div onclick="explainKanji('Âõ≥')" class="bg-white p-6 rounded-xl border-2 border-transparent hover:border-red-500 cursor-pointer shadow-sm transition text-center group">
                    <div class="text-5xl font-jp mb-2 group-hover:scale-110 transition">Âõ≥</div>
                    <div class="text-sm font-bold text-gray-500">ƒê·ªí (B·∫£n ƒë·ªì)</div>
                    <div class="mt-3 text-xs bg-red-50 text-red-700 py-1 rounded">Gi·∫£i th√≠ch AI ‚ú®</div>
                </div>
                <div onclick="explainKanji('Âå∫')" class="bg-white p-6 rounded-xl border-2 border-transparent hover:border-red-500 cursor-pointer shadow-sm transition text-center group">
                    <div class="text-5xl font-jp mb-2 group-hover:scale-110 transition">Âå∫</div>
                    <div class="text-sm font-bold text-gray-500">KHU (Qu·∫≠n)</div>
                    <div class="mt-3 text-xs bg-red-50 text-red-700 py-1 rounded">Gi·∫£i th√≠ch AI ‚ú®</div>
                </div>
                <div onclick="explainKanji('Êùë')" class="bg-white p-6 rounded-xl border-2 border-transparent hover:border-red-500 cursor-pointer shadow-sm transition text-center group">
                    <div class="text-5xl font-jp mb-2 group-hover:scale-110 transition">Êùë</div>
                    <div class="text-sm font-bold text-gray-500">TH√îN (L√†ng)</div>
                    <div class="mt-3 text-xs bg-red-50 text-red-700 py-1 rounded">Gi·∫£i th√≠ch AI ‚ú®</div>
                </div>
            </div>

            <div id="kanjiAiResult" class="hidden bg-white p-8 rounded-xl shadow-inner border-l-8 border-red-600 animate-fade-in">
                <div class="flex justify-between items-start">
                    <h3 id="kanjiTitle" class="text-3xl font-bold text-red-700 font-jp">Â≠ó</h3>
                    <button onclick="closeKanjiAi()" class="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
                </div>
                <div id="kanjiAiLoading" class="mt-4 hidden text-red-500 italic">ƒêang l·∫•y c√¢u chuy·ªán t·ª´ AI...</div>
                <div id="kanjiAiContent" class="mt-4 text-gray-700 leading-relaxed space-y-4"></div>
            </div>
        </section>

        <!-- SECTION: VOCAB -->
        <section id="vocab" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-green-900">T·ª´ V·ª±ng & Ph√°t √Çm ‚ú®</h2>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">B·∫•m üîä ƒë·ªÉ nghe AI ƒë·ªçc</div>
            </div>
            <div class="bg-white shadow rounded-xl overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-green-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-green-800 uppercase">T·ª´ V·ª±ng</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-green-800 uppercase">H√°n T·ª±</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-green-800 uppercase">Nghƒ©a</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-green-800 uppercase">Nghe</th>
                        </tr>
                    </thead>
                    <tbody id="vocabList" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-sm">
        <p>¬© 2024 N4 Speed Master - Powered by Gemini ‚ú® AI</p>
    </footer>

    <script>
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'n4-speed-master-ai';

        const vocabData = [
            { word: "„Åª„Çì„ÇÇ„ÅÆ", kanji: "Êú¨Áâ©", mean: "ƒê·ªì th·∫≠t" },
            { word: "„Åç„Å≥„Åó„ÅÑ", kanji: "Âé≥„Åó„ÅÑ", mean: "Nghi√™m kh·∫Øc" },
            { word: "„Åä„Å£„Åó„ÇÉ„Çã", kanji: "‰ª∞„Çã", mean: "N√≥i (K√≠nh ng·ªØ)" },
            { word: "„Å™„Åï„Çã", kanji: "ÁÇ∫„Åï„Çã", mean: "L√†m (K√≠nh ng·ªØ)" },
            { word: "„ÇÅ„Åó„ÅÇ„Åå„Çã", kanji: "Âè¨„Åó‰∏ä„Åå„Çã", mean: "ƒÇn/U·ªëng (K√≠nh ng·ªØ)" },
            { word: "„Åî„Çâ„Çì„Å´„Å™„Çã", kanji: "„ÅîË¶ß„Å´„Å™„Çã", mean: "Nh√¨n (K√≠nh ng·ªØ)" },
            { word: "„Åü„ÅÑ„Åµ„ÅÜ", kanji: "Âè∞È¢®", mean: "B√£o" }
        ];

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function navTo(id) {
            ['dashboard', 'grammar-ai', 'kanji-ai', 'vocab'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('mobile-menu').classList.add('hidden');
            window.scrollTo(0,0);
        }

        function setInput(val) { document.getElementById('grammarInput').value = val; }

        // --- GEMINI API ---

        async function callGemini(prompt, systemPrompt = "B·∫°n l√† gi√°o vi√™n ti·∫øng Nh·∫≠t chuy√™n nghi·ªáp.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI.");
        }

        async function analyzeGrammar() {
            const input = document.getElementById('grammarInput').value;
            if (!input) return;

            const placeholder = document.getElementById('aiPlaceholder');
            const loading = document.getElementById('aiLoading');
            const content = document.getElementById('aiContent');
            const resultBox = document.getElementById('grammarResult');

            placeholder.classList.add('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            resultBox.classList.remove('border-dashed');

            try {
                const prompt = `Ph√¢n t√≠ch ng·ªØ ph√°p N4 cho c√¢u sau: "${input}". Tr√¨nh b√†y HTML: 1. D·ªãch c√¢u. 2. C√°c m·∫´u ng·ªØ ph√°p (v√≠ d·ª•: ~deshou). 3. Gi·∫£i th√≠ch ng·∫Øn. 4. M·ªôt v√≠ d·ª• t∆∞∆°ng t·ª±.`;
                const response = await callGemini(prompt, "B·∫°n l√† AI Sensei d·∫°y N4 b·∫±ng ti·∫øng Vi·ªát.");
                content.innerHTML = response;
                content.classList.remove('hidden');
            } catch (err) {
                content.innerHTML = `<p class="text-red-500">L·ªói: ${err.message}</p>`;
                content.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function explainKanji(kanji) {
            const resultDiv = document.getElementById('kanjiAiResult');
            const title = document.getElementById('kanjiTitle');
            const loading = document.getElementById('kanjiAiLoading');
            const content = document.getElementById('kanjiAiContent');

            resultDiv.classList.remove('hidden');
            title.innerText = kanji;
            loading.classList.remove('hidden');
            content.innerHTML = '';

            try {
                const prompt = `K·ªÉ c√¢u chuy·ªán chi·∫øt t·ª± ghi nh·ªõ ch·ªØ H√°n: "${kanji}". Tr√¨nh b√†y ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát.`;
                const response = await callGemini(prompt, "B·∫°n l√† chuy√™n gia chi·∫øt t·ª± H√°n t·ª±.");
                content.innerHTML = `<p class='italic text-gray-700'>${response.replace(/\n/g, '<br>')}</p>`;
            } catch (err) {
                content.innerHTML = `<p class="text-red-500">L·ªói: ${err.message}</p>`;
            } finally {
                loading.classList.add('hidden');
            }
        }

        function closeKanjiAi() { document.getElementById('kanjiAiResult').classList.add('hidden'); }

        // --- TTS ---

        async function playTTS(text) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                    }
                };

                const response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                
                const data = await response.json();
                
                // Fix: Check for inlineData inside the first part correctly
                const audioPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (!audioPart) throw new Error("No audio data returned from Gemini");
                
                const pcmData = audioPart.inlineData.data;
                const audioBlob = pcmToWav(pcmData, 24000);
                const audioUrl = URL.createObjectURL(audioBlob);
                new Audio(audioUrl).play();
            } catch (err) { 
                console.error("TTS Error:", err); 
            }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const buffer = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0)).buffer;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + buffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, buffer.byteLength, true);
            return new Blob([wavHeader, buffer], { type: 'audio/wav' });
        }

        function renderVocab() {
            const list = document.getElementById('vocabList');
            vocabData.forEach(v => {
                list.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-jp font-bold text-gray-800">${v.word}</td>
                        <td class="px-6 py-4 font-jp text-gray-600">${v.kanji}</td>
                        <td class="px-6 py-4 text-sm">${v.mean}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="playTTS('${v.word}')" class="text-xl hover:scale-125 transition">üîä</button>
                        </td>
                    </tr>`;
            });
        }

        function initCharts() {
            const ctx1 = document.getElementById('contentChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: ['Kanji', 'Ng·ªØ Ph√°p', 'T·ª´ V·ª±ng'], datasets: [{ data: [20, 30, 50], backgroundColor: ['#BE123C', '#1D4ED8', '#047857'] }] },
                options: { maintainAspectRatio: false }
            });
            const ctx2 = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Ti·∫øn ƒë·ªô (%)', data: [10, 35, 70, 95], borderColor: '#3B82F6', tension: 0.3 }] },
                options: { maintainAspectRatio: false }
            });
        }

        window.onload = () => { initCharts(); renderVocab(); };
    </script>
</body>
</html>